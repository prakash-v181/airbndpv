<% layout('layouts/boilerplate') %>

<div class="row g-4">
  <!-- Listing card -->
  <div class="col-md-8">
    <div class="card border-0 shadow-sm mb-4">
      <% if (listing.image && listing.image.url) { %>
        <img
          src="<%= listing.image.url %>"
          class="card-img-top"
          alt="<%= listing.title %>"
        />
      <% } %>
      <div class="card-body">
        <h3 class="card-title mb-2"><%= listing.title %></h3>

        <p class="text-muted mb-1">
          Owned by
          <span class="fw-semibold">
            <% if (listing.owner && listing.owner.username) { %>
              <%= listing.owner.username %>
            <% } else { %>
              Host
            <% } %>
          </span>
        </p>

        <p class="mb-2"><%= listing.description %></p>

        <p class="mb-1 fw-semibold">
          ₹<%= listing.price %>
        </p>

        <p class="mb-0 text-muted">
          <%= listing.location %><% if (listing.country) { %>, <%= listing.country %><% } %>
        </p>
      </div>
    </div>

    <!-- MAP for this listing -->
    <div class="mt-4">
      <h4 class="h5 mb-3">Location</h4>
      <div
        id="listingMap"
        class="map-card"
        data-location="<%= listing.location %>"
        data-country="<%= listing.country %>"
      ></div>
    </div>
  </div>

  <!-- Right column: edit/delete + review -->
  <div class="col-md-4">
    <%
      let isOwner = false;
      if (currUser && listing.owner) {
        const ownerId = String(listing.owner._id || listing.owner);
        const userId = String(currUser._id);
        if (ownerId === userId) isOwner = true;
      }
    %>

    <% if (isOwner) { %>
      <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning w-100 mb-2">
        Edit listing
      </a>

      <form
        action="/listings/<%= listing._id %>?_method=DELETE"
        method="POST"
        onsubmit="return confirm('Are you sure you want to delete this listing?');"
      >
        <button class="btn btn-danger w-100 mb-3">Delete listing</button>
      </form>
    <% } %>

    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <h5 class="card-title mb-3">Leave a Review</h5>

        <% if (!currUser) { %>
          <p class="text-muted">
            Please <a href="/login">log in</a> to leave a review.
          </p>
        <% } else { %>
          <form
            class="needs-validation"
            novalidate
            action="/listings/<%= listing._id %>/reviews"
            method="POST"
          >
            <div class="mb-3">
              <label for="rating" class="form-label">Rating</label>
              <div class="rating-stars">
                <input type="radio" id="star5" name="review[rating]" value="5" />
                <label for="star5">★</label>
                <input type="radio" id="star4" name="review[rating]" value="4" />
                <label for="star4">★</label>
                <input type="radio" id="star3" name="review[rating]" value="3" />
                <label for="star3">★</label>
                <input type="radio" id="star2" name="review[rating]" value="2" />
                <label for="star2">★</label>
                <input type="radio" id="star1" name="review[rating]" value="1" />
                <label for="star1">★</label>
              </div>
            </div>

            <div class="mb-3">
              <label for="content" class="form-label">Comments</label>
              <textarea
                class="form-control"
                id="content"
                rows="3"
                name="review[comment]"
                required
              ></textarea>
              <div class="invalid-feedback">Please add some comments for review.</div>
            </div>

            <button class="btn btn-outline-dark" type="submit">Submit</button>
          </form>
        <% } %>
      </div>
    </div>
  </div>
</div>

<hr class="my-4" />

<h4 class="h5 mb-3">Reviews</h4>
<div class="row">
  <% if (listing.reviews && listing.reviews.length > 0) { %>
    <% listing.reviews.forEach((review) => { %>
      <div class="col-md-6 mb-3">
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <p class="mb-1">
              <strong>
                <%= review.author && review.author.username ? review.author.username : "User" %>
              </strong>
            </p>
            <p class="mb-1 text-muted-small">
              Rating: <%= review.rating %> / 5
            </p>
            <p class="mb-0"><%= review.comment %></p>
          </div>
        </div>
      </div>
    <% }) %>
  <% } else { %>
    <p class="text-muted">No reviews yet.</p>
  <% } %>
</div>
